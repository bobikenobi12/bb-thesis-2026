AWSTemplateFormatVersion: '2010-09-09'
Description: 'Grape Platform: Cross-Account IAM Role for Infrastructure Management'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Security Configuration"
        Parameters:
          - ExternalId
          - GrapeAwsAccountId
      - Label:
          default: "Resource Customization"
        Parameters:
          - RoleName
    ParameterLabels:
      RoleName:
        default: "IAM Role Name"
      ExternalId:
        default: "External ID"
      GrapeAwsAccountId:
        default: "Grape Account ID"

Parameters:
  GrapeAwsAccountId:
    Type: String
    Default: '787587782604'
    Description: 'The AWS Account ID of the Grape Platform.'
  
  ExternalId:
    Type: String
    Description: 'Unique External ID generated by Grape to secure this connection.'

  RoleName:
    Type: String
    Default: 'GrapeProvisionerRole'
    Description: 'The name of the IAM role to be created.'

Resources:
  GrapeCrossAccountRole:
    Type: AWS::IAM::Role
    DeletionPolicy: Retain
    Properties:
      RoleName: !Sub '${RoleName}-${ExternalId}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${GrapeAwsAccountId}:root'
            Action: 'sts:AssumeRole'
            Condition:
              StringEquals:
                'sts:ExternalId': !Ref ExternalId
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AdministratorAccess'

Outputs:
  RoleArn:
    Description: 'The ARN of the created Role. Please copy this back to the Grape dashboard.'
    Value: !GetAtt GrapeCrossAccountRole.Arn
