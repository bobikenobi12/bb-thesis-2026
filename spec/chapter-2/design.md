# Глава 2. Проектиране на ХИБРИДНА СИСТЕМА ЗА ОРКЕСТРАЦИЯ НА ОБЛАЧНА ИНФРАСТРУКТУРА И СОФТУЕРНИ ПРИЛОЖЕНИЯ ЧРЕЗ CLI И ЦЕНТРАЛИЗИРАНО УПРАВЛЕНИЕ

## 2.1. Функционални изисквания

Основната цел на системата "Grape" е да демократизира достъпа до сложна облачна инфраструктура, позволявайки на разработчици без дълбоки DevOps познания да създават и управляват продуктови среди. **Ключова характеристика е, че потребителите не пишат Terraform код ръчно.** Платформата генерира този код на базата на високоуровневи конфигурации.

Функционалните изисквания са:

1.  **Абстракция на сложността (Template-Driven):** Потребителят дефинира намерение (напр. "Искам Postgres база"), а системата генерира и управлява съответните Terraform модули от библиотека със "Златни шаблони" (Golden Templates).
2.  **Нулева конфигурация на сигурността (Zero-Key Security):** Системата не трябва да изисква от потребителя да генерира и споделя дългосрочни AWS Access Keys. Управлението на достъпа трябва да става чрез делегиране на права (IAM Roles).
3.  **Пълна прозрачност и одит:** Всяко действие по промяна на инфраструктурата трябва да бъде записано, проследимо и свързано с конкретен потребител и Git commit.
4.  **GitOps като стандарт:** Всички конфигурации (дори генерираните автоматично) трябва да се съхраняват в Git хранилища, собственост на потребителя, гарантирайки, че кодът е единственият източник на истината.
5.  **Хибридно управление:** Системата трябва да позволява управление както чрез Command Line Interface (CLI) за бързи операции, така и чрез централизиран уеб портал за визуализация и настройки.

### 2.1.1. Блокова схема на проекта

Архитектурата на системата е разделена на три логически слоя, които взаимодействат помежду си, за да осигурят сигурен и автоматизиран процес на управление.

> **Предложение за фигура:** Блокова схема, показваща трите основни панела: Control Plane (Next.js/Supabase), Execution Plane (Go Workers), и Data Plane (User AWS Account), свързани чрез API и IAM Roles.
> *Фигура 2.1. Архитектурна блокова схема на Grape Platform.*

#### Компонент 1: Контролен панел (Control Plane)
Това е "мозъкът" на системата, разположен в SaaS среда. Той е отговорен за:
*   Съхранение на потребителските намерения (JSON конфигурации).
*   Управление на идентичността (Supabase Auth).
*   Взаимодействие с Git доставчици (създаване на хранилища).
*   Оркестрация на работните процеси (Triggering Workers).

#### Компонент 2: Изпълнителен панел (Execution Plane / Worker Fleet)
Това е динамичният слой на системата, съставен от множество изолирани работни процеси (Workers), работещи в ефимерни контейнери.
*   **Генератор на код:** Работникът изтегля "Златните шаблони", попълва ги с променливите на потребителя и ги записва (push) в хранилището на потребителя.
*   **Изпълнител на IaC:** Стартира `terraform apply` върху генерирания код, използвайки IAM роля за достъп до AWS акаунта на клиента.
*   **GitOps Bootstrapper:** Инсталира и конфигурира ArgoCD в създадения клъстер.

#### Компонент 3: Потребителска инфраструктура (Data Plane)
Това е целевата среда, където живеят реалните ресурси на клиента. Тя се намира изцяло в AWS акаунта на потребителя, гарантирайки собственост върху данните.
*   **IAM Role:** Доверителен механизъм за връзка със SaaS платформата.
*   **EKS Cluster:** Средата за изпълнение на приложенията, управлявана от ArgoCD.
*   **Генерирани Хранилища:** Git хранилищата (Infra & GitOps), които платформата попълва автоматично.

## 2.2. Избор на облачна среда

За първоначалната реализация на платформата е избран **Amazon Web Services (AWS)** като водещ облачен доставчик с най-голям пазарен дял и най-зряла екосистема от инструменти.

Изборът на AWS се базира на следните фактори:
*   **Elastic Kubernetes Service (EKS):** Управлявана Kubernetes услуга, която премахва необходимостта от ръчно управление на Control Plane-а на клъстера.
*   **IAM Roles for Service Accounts (IRSA):** Позволява фино-гранулирано управление на достъпа на ниво под (pod), което е критично за сигурността на "Zero-Key" архитектурата.
*   **Глобално присъствие:** Възможност за разгръщане на ресурси в множество региони.

## 2.3. Избор на IaC инструмент за създаване на инфраструктурата

За дефиниране и управление на инфраструктурата е избран **Terraform** на HashiCorp.

Мотивите за този избор са:
1.  **Декларативен език (HCL):** Позволява описване на желаното крайно състояние. Системата генерира този HCL код автоматично от шаблони.
2.  **Управление на състоянието (State Management):** Terraform поддържа строго проследяване на текущото състояние на ресурсите, което позволява на системата да засича промени (drifts).
3.  **Богата екосистема:** Наличието на официални AWS модули и провайдъри.
4.  **Агностичност:** Поддържа стратегията за бъдещо мулти-облачно развитие.

## 2.4. Избор на инструмент за контейнеризация

За опаковане на приложенията и работните процеси е избран **Docker**.

Ролята на Docker в системата е фокусирана върху **Execution Plane**:
*   **Изолация на Работниците:** Самата платформа използва Docker контейнери за изпълнение на задачите по генериране на код и деплоймънт. Това гарантира "стерилна стая" за всеки клиент – работникът за Клиент А няма достъп до файловата система или паметта на работника за Клиент Б.
*   **Версиониране на инструментите:** Позволява лесно обновяване на версиите на Terraform и Helm в платформата чрез смяна на Docker image-а на работниците.

*(Забележка: Изграждането на Docker images за потребителските приложения е извън обхвата на платформата за инфраструктура - това се поема от CI/CD пайплайните на клиента или ArgoCD).*

## 2.5. Избор на инструмент за оркестрация на контейнери

Като де факто стандарт в индустрията, **Kubernetes** е избран за оркестрация на контейнерите.

В рамките на платформата, Kubernetes се използва в две направления:
*   **Целева среда (Target Runtime):** Потребителските приложения се разгръщат в Amazon EKS клъстери.
*   **GitOps Двигател:** Върху Kubernetes клъстера се инсталира **ArgoCD**. Това е инструмент, който непрекъснато синхронизира състоянието на клъстера с конфигурациите в GitOps хранилището (което се попълва автоматично от платформата).

## 2.6. Избор на технологии за изработка на ХИБРИДНА СИСТЕМА (Frontend)

За изработката на потребителския интерфейс (Control Plane UI) е избран технологичният стек на **Next.js** и **React**.

### Next.js
Това е React рамка (framework), която предоставя възможности за "Server-Side Rendering" (SSR).
*   **API Routes:** Обслужва заявки от CLI инструмента.
*   **Екосистема:** Готови компоненти за интеграция.

### TypeScript
Използването на TypeScript добавя строга типизация, което е критично за работа със сложни структури от данни като Terraform конфигурации.

### Tailwind CSS и UI Библиотеки
За стилизиране се използва Tailwind CSS в комбинация с `shadcn/ui` за модерен и консистентен визуален език.

## 2.7. Избор на база данни за съхранение на данни

За съхранение на системните данни и управление на сесиите е избрана платформата **Supabase** (PostgreSQL).

### PostgreSQL
Релационна база данни за съхранение на:
*   **Configurations:** JSON обектите с потребителските настройки.
*   **Deployments:** История на внедряванията.
*   **Relations:** Връзките между потребители и организации.

### Supabase Auth & Realtime
Предоставя автентикация и мигновени обновления на интерфейса (Realtime) при промяна на статуса на деплоймънт.

## 2.8. Избор на технологии за изработка на сървъра

Сървърната логика на "Изпълнителния панел" (Execution Plane) е реализирана на езика **Go (Golang)**.

### Go Language
Избран заради:
1.  **Производителност:** Ефективно изпълнение на паралелни задачи (goroutines).
2.  **Статична компилация:** Лесно разпространение на работниците (Workers) като единичен бинарен файл.
3.  **Cloud Native библиотеки:** Отлична поддръжка на AWS SDK, Kubernetes Client-Go и Git.

### Архитектура на Работника (Worker)
*   Приема JSON спецификация на задачата.
*   Генерира Terraform код от шаблони.
*   Изпълнява Terraform и Helm.
*   Изпраща логове към Supabase.
