# Глава 2. Проектиране на ХИБРИДНА СИСТЕМА ЗА ОРКЕСТРАЦИЯ НА ОБЛАЧНА ИНФРАСТРУКТУРА И СОФТУЕРНИ ПРИЛОЖЕНИЯ ЧРЕЗ CLI И ЦЕНТРАЛИЗИРАНО УПРАВЛЕНИЕ

## 2.1. Функционални изисквания

Основната цел на системата "Grape" е да демократизира достъпа до сложна облачна инфраструктура, позволявайки на разработчици без дълбоки DevOps познания да създават и управляват продуктови среди. За да се постигне това, системата трябва да отговаря на следните функционални изисквания:

1.  **Абстракция на сложността:** Потребителят не трябва да пише Terraform или Helm манифести ръчно за стандартни задачи.
2.  **Нулева конфигурация на сигурността (Zero-Key Security):** Системата не трябва да изисква от потребителя да генерира и споделя дългосрочни AWS Access Keys. Управлението на достъпа трябва да става чрез делегиране на права (IAM Roles).
3.  **Пълна прозрачност и одит:** Всяко действие по промяна на инфраструктурата трябва да бъде записано, проследимо и свързано с конкретен потребител и Git commit.
4.  **GitOps като стандарт:** Всички конфигурации трябва да се съхраняват в Git хранилища, собственост на потребителя, гарантирайки, че кодът е единственият източник на истината.
5.  **Хибридно управление:** Системата трябва да позволява управление както чрез Command Line Interface (CLI) за бързи операции, така и чрез централизиран уеб портал за визуализация и настройки.

### 2.1.1. Блокова схема на проекта

Архитектурата на системата е разделена на три логически слоя, които взаимодействат помежду си, за да осигурят сигурен и автоматизиран процес на управление.

> **Предложение за фигура:** Блокова схема, показваща трите основни панела: Control Plane (Next.js/Supabase), Execution Plane (Go Workers), и Data Plane (User AWS Account), свързани чрез API и IAM Roles.
> *Фигура 2.1. Архитектурна блокова схема на Grape Platform.*

#### Компонент 1: Контролен панел (Control Plane)
Това е "мозъкът" на системата, разположен в SaaS среда. Той е отговорен за взаимодействието с потребителя, управлението на идентичността и съхранението на мета-данните. Контролният панел не извършва директни промени в инфраструктурата, а само оркестрира процесите. Той приема заявки от потребителите (през Уеб или CLI), валидира ги и създава задачи за изпълнение. Също така, той служи като "слушател" (Webhook Receiver) за събития от системите за контрол на версиите (GitHub/GitLab).

#### Компонент 2: Изпълнителен панел (Execution Plane / Worker Fleet)
Това е динамичният слой на системата, съставен от множество изолирани работни процеси (Workers). Всеки работник е ефимерен – създава се при възникване на задача (например "Deploy to Staging") и се унищожава след приключването ѝ. Този компонент е единственият, който комуникира директно с облачния доставчик на клиента. Той изтегля кода от Git, изпълнява инфраструктурните скриптове (Terraform) и конфигурира Kubernetes клъстерите.

#### Компонент 3: Потребителска инфраструктура (Data Plane)
Това е целевата среда, където живеят реалните ресурси на клиента. Тя се намира изцяло в AWS акаунта на потребителя, гарантирайки собственост върху данните. Връзката между този слой и Изпълнителния панел се осъществява чрез доверителна връзка (Trust Relationship), създадена чрез стандарта OpenID Connect (OIDC) и AWS IAM. Тук се намират виртуалните мрежи (VPC), клъстерите (EKS), базите данни и самите потребителски приложения.

## 2.2. Избор на облачна среда

За първоначалната реализация на платформата е избран **Amazon Web Services (AWS)** като водещ облачен доставчик с най-голям пазарен дял и най-зряла екосистема от инструменти.

Изборът на AWS се базира на следните фактори:
*   **Elastic Kubernetes Service (EKS):** Управлявана Kubernetes услуга, която премахва необходимостта от ръчно управление на Control Plane-а на клъстера.
*   **IAM Roles for Service Accounts (IRSA):** Позволява фино-гранулирано управление на достъпа на ниво под (pod), което е критично за сигурността на "Zero-Key" архитектурата.
*   **Глобално присъствие:** Възможност за разгръщане на ресурси в множество региони, което е важно за скалируемостта на потребителските приложения.

Въпреки че текущата реализация е фокусирана върху AWS, архитектурата е проектирана модулно (чрез използване на Terraform), което позволява бъдещо разширение към Microsoft Azure и Google Cloud Platform (GCP) без промяна в основните бизнес процеси на платформата.

## 2.3. Избор на IaC инструмент за създаване на инфраструктурата

За дефиниране и управление на инфраструктурата е избран **Terraform** на HashiCorp.

Мотивите за този избор са:
1.  **Декларативен език (HCL):** Позволява описване на желаното крайно състояние, а не стъпките за постигането му. Това опростява одита и намалява грешките.
2.  **Управление на състоянието (State Management):** Terraform поддържа строго проследяване на текущото състояние на ресурсите, което позволява на системата да засича промени (drifts) и да планира само необходимите обновявания.
3.  **Богата екосистема:** Наличието на официални AWS модули и провайдъри ускорява разработката и гарантира поддръжка на най-новите облачни услуги.
4.  **Агностичност:** За разлика от AWS CloudFormation, Terraform не е заключен към един доставчик, което подкрепя стратегията за бъдещо мулти-облачно развитие.

## 2.4. Избор на инструмент за контейнеризация

За опаковане на приложенията и работните процеси е избран **Docker**.

Ролята на Docker в системата е двойна:
1.  **За потребителските приложения:** Платформата изисква приложенията да бъдат контейнеризирани (да имат Dockerfile), за да могат да бъдат разгърнати в Kubernetes среда. Това осигурява преносимост и елиминира несъответствията между средата за разработка и продукционната среда.
2.  **За системните работници (Workers):** Самата платформа използва Docker контейнери за изпълнение на задачите по внедряване. Това позволява изолиране на средата на всеки клиент – работникът за Клиент А няма достъп до файловата система или паметта на работника за Клиент Б.

## 2.5. Избор на инструмент за оркестрация на контейнери

Като де факто стандарт в индустрията, **Kubernetes** е избран за оркестрация на контейнерите.

В рамките на платформата, Kubernetes се използва в две направления:
*   **Целева среда (Target Runtime):** Потребителските приложения се разгръщат в Amazon EKS клъстери. Kubernetes предоставя необходимите абстракции за скалиране (Horizontal Pod Autoscaler), самолекуване (Restart Policy) и откриване на услуги (Service Discovery).
*   **GitOps Двигател:** Върху Kubernetes клъстера се инсталира **ArgoCD**. Това е инструмент, който непрекъснато синхронизира състоянието на клъстера с конфигурациите в Git хранилището. Изборът на ArgoCD позволява реализирането на GitOps модела, който е централен за философията на Grape.

## 2.6. Избор на технологии за изработка на ХИБРИДНА СИСТЕМА (Frontend)

За изработката на потребителския интерфейс (Control Plane UI) е избран технологичният стек на **Next.js** и **React**.

### Next.js
Това е React рамка (framework), която предоставя възможности за "Server-Side Rendering" (SSR) и генериране на статични сайтове. Изборът е обусловен от:
*   **Производителност:** Бързо първоначално зареждане на страниците благодарение на сървърното рендиране.
*   **API Routes:** Възможност за създаване на олекотени API крайни точки (endpoints) директно в Next.js приложението, които обслужват заявки от CLI инструмента.
*   **Екосистема:** Огромна библиотека от готови компоненти и инструменти за интеграция.

### TypeScript
Използването на TypeScript добавя строга типизация към JavaScript кода. Това е критично за проект с такъв мащаб, тъй като предотвратява множество грешки по време на компилация и улеснява поддръжката на кода, особено при работа със сложни структури от данни като Terraform конфигурации и AWS отговори.

### Tailwind CSS и UI Библиотеки
За стилизиране се използва Tailwind CSS, който позволява бързо изграждане на модерни интерфейси чрез ютилити класове. В комбинация с компоненти като `shadcn/ui`, се постига професионален и консистентен визуален език с минимални усилия.

## 2.7. Избор на база данни за съхранение на данни

За съхранение на системните данни и управление на сесиите е избрана платформата **Supabase**, която е изградена върху **PostgreSQL**.

### PostgreSQL
Релационна база данни с отворен код, известна със своята надеждност и възможности за разширение. В нея се съхраняват:
*   **Configurations:** Настройките на потребителските проекти (VPC CIDR блокове, типове инстанции).
*   **Deployments:** История на всички внедрявания, включително статус, време на изпълнение и препратки към логовете.
*   **Relations:** Връзките между потребители, организации и проекти.

### Supabase Auth & Realtime
Supabase предоставя готов модул за автентикация, който лесно се интегрира с OAuth доставчици (GitHub, GitLab). Освен това, функцията "Realtime" позволява на уеб интерфейса да получава мигновени обновления. Например, когато CLI инструментът стартира внедряване и статусът в базата данни се промени на "Running", уеб интерфейсът автоматично отразява това без нужда от презареждане на страницата. Това е ключово за доброто потребителско преживяване (UX).

## 2.8. Избор на технологии за изработка на сървъра

Сървърната логика на "Изпълнителния панел" (Execution Plane) е реализирана на езика **Go (Golang)**.

### Go Language
Go е избран заради своите уникални характеристики, подходящи за облачна инфраструктура и CLI инструменти:
1.  **Производителност и Конкурентност:** Вградените "goroutines" позволяват ефективно изпълнение на паралелни задачи (например изчакване на множество AWS ресурси да станат активни едновременно), консумирайки минимална памет.
2.  **Статично типизиране и компилация:** Go се компилира до единичен бинарен файл, което прави разпространението на работниците (Workers) и CLI инструмента изключително лесно – няма нужда от инсталиране на зависимости (за разлика от Python или Node.js).
3.  **Богата Cloud Native библиотека:** Go е езикът на облака (Kubernetes, Terraform, Docker са написани на Go). Това означава, че съществуват отлични библиотеки за работа с AWS SDK, Kubernetes Client-Go и Git, които се интегрират нативно в проекта.

### Архитектура на Работника (Worker)
Работниците са проектирани като самостоятелни Go приложения, които:
*   Приемат "Job Specification" (JSON обект с данни за репо, комит и конфигурация).
*   Използват AWS SDK за Go v2 за поемане на IAM роли.
*   Изпълняват външни команди (Terraform, Helm) чрез пакета `os/exec`, като прихващат `stdout` и `stderr` за поточно предаване на логовете към Supabase.
