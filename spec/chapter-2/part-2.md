# Глава 2 (Продължение). Проектиране на системата

## 2.3. Избор на облачна среда

Изборът на облачен доставчик е фундаментално решение, което дефинира границите на възможностите, скалируемостта и архитектурните модели на платформата. За реализацията на "Grape" е избрана платформата **Amazon Web Services (AWS)**. Този избор не е случаен, а е продиктуван от няколко критични технически и пазарни фактора.

### 2.3.1. Зрялост и пазарен дял
AWS е пионерът в облачните изчисления и продължава да държи най-големия пазарен дял. Това осигурява най-богатата екосистема от инструменти, документация и общностна поддръжка. За една **IDP** платформа, която цели да абстрахира сложността, наличието на стабилни и добре документирани **API** интерфейси е от първостепенно значение.

### 2.3.2. Управлявана Kubernetes услуга (EKS)
**Amazon Elastic Kubernetes Service (EKS)** е избрана за хостинг на потребителските приложения (Workloads). За разлика от саморъчно инсталираните **K8s** клъстери (self-managed), EKS поема отговорността за управляващия слой (Control Plane).
*   **Висока наличност:** AWS автоматично репликира Control Plane инстанциите през множество зони на наличност (**AZ**), гарантирайки 99.95% SLA.
*   **Интеграция:** EKS предоставя нативна интеграция с VPC CNI (за мрежова свързаност на ниво Pod) и IAM, което опростява мрежовите политики и сигурността.

### 2.3.3. Управление на идентичността (IAM & IRSA)
Ключов елемент в архитектурата за сигурност на Grape е механизмът **IAM Roles for Service Accounts (IRSA)**.
*   **Принцип:** IRSA позволява асоциирането на AWS IAM роля директно с Kubernetes Service Account. Това означава, че един Pod (например Ingress Controller или ExternalDNS) може да получава временни AWS кредити чрез OIDC федерация, без да се налага монтирането на Access Keys като променливи на средата.
*   **Приложение:** Това е фундаментът на "Zero-Key" архитектурата, позволяващ на нашите компоненти да управляват AWS ресурси (като Route53 записи или S3 кофи) по сигурен и одитируем начин.

## 2.4. Избор на IaC инструмент за създаване на инфраструктурата

За реализиране на парадигмата **Infrastructure as Code (IaC)** е избран **Terraform** на HashiCorp. Този избор е направен след сравнителен анализ с алтернативи като AWS CloudFormation и Pulumi.

### 2.4.1. Декларативен модел и HCL
Terraform използва **HashiCorp Configuration Language (HCL)** – език, проектиран да бъде едновременно четим от хора и машини.
*   **Предимство:** За разлика от императивните езици (като Python в Pulumi) или прекалено вербозните JSON/YAML дефиниции (CloudFormation), HCL предлага ясна структура, която описва *крайното състояние* на ресурсите. Това намалява риска от конфигурационни отклонения (drift) и улеснява прегледа на промените (Code Review) преди прилагането им [1].

### 2.4.2. Управление на състоянието (State Management)
Една от най-силните страни на Terraform е неговият механизъм за управление на състоянието.
*   **State File:** Terraform поддържа файл (tfstate), който мапва реалните ресурси в облака към конфигурационния код.
*   **Locking:** Чрез използване на **S3** за съхранение на състоянието и **DynamoDB** за заключване, системата предотвратява едновременни модификации от различни процеси. Това е критично за нашата архитектура с паралелни работници (Workers), гарантирайки атомарност на операциите.

### 2.4.3. Модулна архитектура и Провайдъри
Архитектурата на Terraform е базирана на плъгини (Providers), които комуникират с ядрото чрез **RPC**.
*   **AWS Provider:** Официалният AWS провайдър се обновява ежеседмично, осигурявайки поддръжка за най-новите услуги веднага след пускането им.
*   **Kubernetes & Helm Providers:** Възможността на Terraform да управлява не само инфраструктура (VMs, VPC), но и логически ресурси вътре в клъстера (чрез Helm Charts), ни позволява да създадем унифициран пайплайн. В нашата система Terraform се грижи за "грубата" инфраструктура, след което предава щафетата на **ArgoCD** за управление на приложенията – модел, известен като "App of Apps" [5].

### 2.4.4. Интеграция с FinOps (Infracost)
Изборът на Terraform позволява директна интеграция с инструменти за оценка на разходите като **Infracost**. Тъй като Terraform генерира детайлен план за изпълнение (execution plan) преди реалната промяна, Infracost може да анализира този план и да изчисли прогнозната промяна в месечната сметка. Това дава видимост на потребителите още по време на Pull Request етапа, реализирайки "Shift-Left" подход във финансите [2], [8].
