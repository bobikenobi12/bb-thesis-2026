# Интеграция с AWS (AWS Onboarding)

## Въведение
Този документ описва процеса на свързване (onboarding) на потребителски AWS акаунт към платформата Trellis (ADP). Целта е да се осигури сигурен достъп до облачните ресурси на потребителя, използвайки модела **Bring Your Own Cloud (BYOC)**, без да се излагат постоянни ключове за достъп.

## Архитектура
Процесът разчита на **Cross-Account IAM Role** механизъм, който е индустриален стандарт за делегиране на права между AWS акаунти [1].

### Компоненти
1.  **Identity Schema (`cloud_identities`):** Нова таблица в базата данни, която отделя идентификацията от конфигурацията на инфраструктурата.
2.  **External ID:** Уникален идентификатор, генериран от Trellis за всеки потребител, предотвратяващ "Confused Deputy" атаки.
3.  **Infrastructure Templates:** Готови шаблони за CloudFormation и Terraform, които автоматизират създаването на ролята.

## Потребителски процес (Flow)

1.  **Инициализация:**
    *   При първо влизане, системата проверява наличието на свързан облачен акаунт.
    *   Ако липсва такъв, потребителят се пренасочва към `/onboarding/aws`.

2.  **Създаване на Роля:**
    *   Потребителят избира метод: **CloudFormation** (автоматизиран) или **Terraform** (IaC).
    *   Trellis генерира уникален `ExternalId`.
    *   Потребителят стартира шаблона в своя AWS акаунт.

3.  **Свързване:**
    *   Потребителят въвежда получения `Role ARN` в интерфейса на Trellis.
    *   Системата валидира формата на ARN и записва връзката в `cloud_identities`.

4.  **Пропускане (Skip Logic):**
    *   Потребителят може да избере "Skip for now".
    *   Това действие се запазва локално (`localStorage`), за да се предотврати повторно пренасочване.
    *   В таблото за управление (Dashboard) се появява персистентно предупреждение (Alert), че провизирането на ресурси е невъзможно без активна връзка.

## Техническа реализация

### Схема на базата данни

```sql
CREATE TABLE cloud_identities (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    provider TEXT CHECK (provider IN ('aws', 'azure', 'gcp')),
    credentials JSONB -- Съдържа role_arn, external_id
);
```

### Сигурност
*   **External ID:** Използва се за установяване на доверие (Trust Relationship) само между конкретния потребителски акаунт и Trellis SaaS акаунта.
*   **Validation:** Сървърна проверка на формата на ARN и принадлежността на `ExternalId` към сесията на потребителя.

---
**Използвана Литература:**
[1] AWS Documentation. "IAM Roles for Cross-Account Access."
