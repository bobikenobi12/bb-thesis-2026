# 3.5. Реализация на GitOps и Kubernetes интеграция

Интеграцията между инфраструктурния слой (Terraform) и приложния слой (Kubernetes) е реализирана чрез GitOps методологията, използвайки **ArgoCD** като де факто стандарт за непрекъснато доставяне (Continuous Delivery) в Kubernetes среда.

## 3.5.1. Bootstrapping на ArgoCD

Процесът на "bootstrapping" е автоматизиран от CLI инструмента и превръща "празния" EKS клъстер в напълно функционална платформа.

### 3.5.1.1. Инсталация чрез Helm
Въпреки че крайната цел е GitOps, първоначалната инсталация на ArgoCD се извършва императивно чрез Helm клиента, вграден в Grape CLI. Това е необходимо, за да се прекъсне проблемът "кокошката или яйцето" (няма кой да инсталира ArgoCD, преди ArgoCD да е там).
CLI използва локални Helm чартове (`helm/argo-cd`), което гарантира, че инсталацията не зависи от външни хранилища по време на изпълнение.

### 3.5.1.2. Моделът "App of Apps"
След като ArgoCD е стартиран, CLI прилага един единствен манифест - т.нар. **Root App** или "App of Apps". Този манифест сочи към Git хранилището на клиента (`client_argo_repo`) и инструктира ArgoCD да следи директорията `manifests/applications`. В тази директория се намират дефинициите на всички останали приложения (Karpenter, ExternalDNS, Ingress Controllers), които ArgoCD автоматично засича и разгръща.

## 3.5.2. Механизъм за "Infra Facts"

Едно от най-големите предизвикателства при автоматизацията е предаването на данни от Terraform (напр. ARN на IAM роля, endpoint на база данни) към Kubernetes манифестите. Grape решава това чрез механизма **"Infra Facts"**.

1.  **Extract:** След успешното изпълнение на `terraform apply`, CLI извлича всички outputs в JSON формат.
2.  **Transform:** Тези данни се преобразуват в YAML файл, наречен `infra-facts.yaml`.
3.  **Load:** Файлът се записва (commit & push) в GitOps хранилището на клиента, в директорията със стойности (Values) за съответния Helm чарт (`helm/infra-services/values/...`).

```yaml
# Примерно съдържание на infra-facts.yaml
infra-services:
  eks_cluster_name: "eks-ew1-dev-igxadp"
  aws_region: "eu-west-1"
  karpenter_iam_role_arn: "arn:aws:iam::123456789012:role/KarpenterIRSA..."
  rds_endpoint: "grape-db.cluster-....rds.amazonaws.com"
```

Когато ArgoCD засече промяна в този файл, той автоматично обновява Helm рилийзите, инжектирайки новите стойности в конфигурацията на системните услуги.

## 3.6. Реализация на Документационния портал

За да бъде платформата използваема от широк кръг разработчици, тя разполага с модерен документационен портал, реализиран в директорията `apps/docs`. Порталът е изграден върху **Next.js** и рамката **Fumadocs**.

## 3.6.1. Архитектура с Fumadocs

Изборът на **Fumadocs** позволява бързо изграждане на документация с висока производителност и отлична SEO оптимизация.

### 3.6.1.1. MDX и Content Collections
Съдържанието се пише в **MDX** формат (Markdown + React компоненти). Това позволява вграждане на интерактивни елементи (диаграми, бутони за копиране, табове) директно в текста. Файлът `source.config.ts` дефинира колекциите от документи и правилата за валидация на метаданните (Frontmatter).

### 3.6.1.2. Динамично маршрутизиране
Next.js App Router (`app/docs/[[...slug]]/page.tsx`) се използва за генериране на статични страници по време на build (Static Site Generation - SSG). Това гарантира мигновено зареждане за крайния потребител.

```typescript
// apps/docs/app/docs/[[...slug]]/page.tsx
export async function generateStaticParams() {
  return source.generateParams();
}
```

## 3.6.2. Функционалности на портала

### 3.6.2.1. Търсене (Orama)
Интегрирана е търсачката **Orama** (чрез плъгина на Fumadocs), която извършва пълнотекстово търсене (fuzzy search) изцяло в браузъра на клиента, без нужда от външен сървър за индексиране.

### 3.6.2.2. AI Интеграция (LLMs.txt)
Порталът автоматично генерира файл `/llms.txt` и `/llms-full.txt`. Този стандартизиран формат предоставя съдържанието на документацията в чист текст, оптимизиран за консумация от Големи Езикови Модели (LLMs) като ChatGPT или Claude. Това позволява на потребителите лесно да захранят AI асистент с контекста на Grape платформата.

### 3.6.2.3. Автоматични OG изображения
За всяка страница от документацията се генерира автоматично "Open Graph" изображение (`app/og/docs/[...slug]/route.tsx`), съдържащо заглавието и описанието на страницата. Това подобрява видимостта при споделяне в социални мрежи и чат платформи.
